<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Sorteo Campfire</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  :root{
    --bg:#0c1622;
    --card:#132033;
    --accent:#3fa9f5;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:var(--bg);
    color:#fff;
    font-family:Arial, system-ui, sans-serif;
    padding:20px;
    text-align:center;
  }
  h1{ margin-bottom:20px; }

  #fileInput{
    width:100%;
    max-width:480px;
    padding:12px;
    font-size:1rem;
    background:var(--accent);
    color:white;
    border:none;
    border-radius:10px;
  }
  #hint{margin-top:8px;font-size:.9rem;opacity:.8;}
  #captureInfo{margin-top:10px;font-weight:bold;}

  #counters{
    margin:15px auto;
    max-width:480px;
    display:flex;
    justify-content:space-between;
    background:var(--card);
    padding:8px 12px;
    border-radius:10px;
  }

  #layout{
    margin-top:20px;
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    justify-content:center;
  }

  #leftSide{flex:0 0 auto;}
  #rightSide{
    flex:0 0 250px;
    background:var(--card);
    padding:15px;
    border-radius:10px;
    max-height:450px;
    overflow-y:auto;
    text-align:left;
  }
  #rightSide h3{text-align:center;margin-bottom:10px;}
  #listaUsuarios li{
    border-bottom:1px solid rgba(255,255,255,.1);
    padding:4px 0;
  }

  /* ==== RULETA ==== */
  #spinWheel{
    position:relative;
    display:inline-block;
    overflow:hidden;
  }

  #spinWheel::after {
    content:"";
    position:absolute;
    top:0px;
    left:calc(50% - 10px);
    width:0;height:0;
    border-left:10px solid transparent;
    border-right:10px solid transparent;
    border-top:20px solid #feeb69;
    filter:drop-shadow(1px 2px 2px rgba(0,0,0,.5));
  }

  #spin{
    position:absolute;
    top:50%;left:50%;
    width:70px;height:70px;
    background:#333;
    color:white;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transform:translate(-50%,-50%);
    cursor:pointer;
    box-shadow:0 0 0 4px #fff,0 0 15px rgba(0,0,0,.5);
    z-index:20;
  }

  .buttons button{
    margin:8px;
    padding:10px 18px;
    border:none;
    background:var(--accent);
    color:white;
    border-radius:10px;
    cursor:pointer;
  }

  #winnerBox{
    margin-top:15px;
    background:var(--card);
    padding:12px;
    border-radius:10px;
    display:none;
    font-size:1.1rem;
  }

  .user-owner{color:rgb(231,67,122);font-weight:bold;}
  .user-admin{color:rgb(244,166,42);font-weight:bold;}
  .user-gray {color:rgb(200,200,200);}
  .user-unknown{color:#fff;}

</style>
</head>

<body>

<h1>ðŸŽ‰ Sorteo Campfire</h1>

<input id="fileInput" type="file" multiple accept="image/*" />
<div id="hint">Puedes subir varias capturas, no reemplaza las anteriores.</div>
<div id="captureInfo">Capturas subidas: 0</div>

<div id="counters">
  <span>Total @ Ãºnicos: <b id="totalDetectados">0</b></span>
  <span>Participantes (grises): <b id="totalGrises">0</b></span>
</div>

<div id="layout">
  <div id="leftSide">

    <div id="spinWheel">
      <canvas id="wheel" width="400" height="400"></canvas>
      <div id="spin">GO</div>
    </div>

    <div class="buttons">
      <button id="btnBest1" disabled>Girar (mejor de 1)</button>
      <button id="btnBest3" disabled>Girar (mejor de 3)</button>
    </div>

    <div id="winnerBox"></div>

  </div>

  <div id="rightSide">
    <h3>Participantes</h3>
    <ul id="listaUsuarios"></ul>
  </div>
</div>

<script>
/* ============================================================
   CONFIG â€” TU WEBAPP DE APPS SCRIPT
============================================================ */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzp3ucVx_KSlO2uo_xzZL5QmNcivWZ5E3A3N3t8opt3235FsV_iDIHMLmoNa5BWT3xLHg/exec";  /* <-- CAMBIAR SOLO ESTO */

/* ============================================================
   RULETA (SPINWHEEL ORIGINAL)
============================================================ */
class EventEmitter{constructor(){this.l={}}on(e,f){(this.l[e]??=[]).push(f)}emit(e,...a){(this.l[e]||[]).forEach(fn=>fn(...a))}}
class SpinWheel{
  constructor({canvasSelector,buttonSelector,sectors,friction=0.991}) {
    this.sectors=sectors;
    this.canvas=document.querySelector(canvasSelector);
    this.ctx=this.canvas.getContext("2d");
    this.button=document.querySelector(buttonSelector);
    this.friction=friction;

    this.diameter=this.canvas.width;
    this.radius=this.diameter/2;

    this.total=sectors.length;
    this.arc=(2*Math.PI)/this.total;

    this.angle=0;
    this.angularVelocity=0;
    this.spinButtonClicked=false;

    this.events=new EventEmitter();
    this.init();
  }

  get currentIndex(){
    return Math.floor(this.total - (this.angle/(2*Math.PI))*this.total)%this.total;
  }

  drawSector(s,i){
    const start=this.arc*i;
    this.ctx.save();
    this.ctx.beginPath();
    this.ctx.fillStyle=s.color;
    this.ctx.moveTo(this.radius,this.radius);
    this.ctx.arc(this.radius,this.radius,this.radius,start,start+this.arc);
    this.ctx.closePath();
    this.ctx.fill();

    this.ctx.translate(this.radius,this.radius);
    this.ctx.rotate(start+this.arc/2);
    this.ctx.textAlign="right";
    this.ctx.fillStyle=s.textColor;
    this.ctx.font="bold 20px Arial";
    this.ctx.fillText(s.label,this.radius-10,5);
    this.ctx.restore();
  }

  rotateCanvas(){
    this.canvas.style.transform=`rotate(${this.angle-Math.PI/2}rad)`;
  }

  updateFrame(){
    if(!this.angularVelocity && this.spinButtonClicked){
      const win=this.sectors[this.currentIndex];
      this.events.emit("finishSpinning",win);
      this.spinButtonClicked=false;
      return;
    }
    this.angularVelocity*=this.friction;
    if(this.angularVelocity<0.002) this.angularVelocity=0;

    this.angle+=this.angularVelocity;
    this.angle%=(2*Math.PI);

    this.rotateCanvas();
  }

  start(){
    const animate=()=>{
      this.updateFrame();
      requestAnimationFrame(animate);
    };
    animate();
  }

  init(){
    this.sectors.forEach((s,i)=>this.drawSector(s,i));
    this.rotateCanvas();
    this.start();

    this.button.addEventListener("click",()=>{
      if(!this.angularVelocity){
        this.angularVelocity=Math.random()*0.2+0.25;
      }
      this.spinButtonClicked=true;
    });
  }
}

/* ============================================================
   OCR + PARTICIPANTES
============================================================ */

const fileInput=document.getElementById("fileInput");
let seenFiles=new Set();
let userColors=new Map();
let listaATodo=[];
let participants=[];

const listaProhibidos=[
  "@PokeComasGO","@BryanStar17","@Alvaro2399","@iDaniel095",
  "@JSAP26","@AdminExtra3","@AdminExtra4","@AdminExtra5"
];

fileInput.addEventListener("change",async()=>{
  const files=[...fileInput.files];
  const nuevos=[];
  for(const f of files){
    const key=`${f.name}|${f.size}|${f.lastModified}`;
    if(!seenFiles.has(key)){seenFiles.add(key); nuevos.push(f);}
  }

  document.getElementById("captureInfo").textContent=
    `Capturas subidas: ${seenFiles.size}`;

  for(const f of nuevos){
    await enviarImagenAGAS(f);
  }

  buildParticipants();
  updateUI();
});

/* === ENVÃO A GOOGLE APPS SCRIPT === */
async function enviarImagenAGAS(file){
  return new Promise((resolve)=>{
    const reader=new FileReader();
    reader.onload=async()=>{
      const base64=reader.result.split(",")[1];

      try{
        const res=await fetch(WEBAPP_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ image:base64 })
        });

        const json=await res.json();
        if(json.ok){
          procesarTextoOCR(json.text);
        } else{
          console.error("OCR ERROR:",json.error);
        }
      } catch(err){
        console.error("FETCH ERROR",err);
      }
      resolve();
    };
    reader.readAsDataURL(file);
  });
}

/* === PROCESAR TEXTO OCR === */
function procesarTextoOCR(text){
  const encontrados=text.match(/@[A-Za-z0-9_]+/g)||[];

  for(let h of encontrados){
    if(listaProhibidos.includes(h)) continue;
    h=h.replace(/[^@A-Za-z0-9_]/g,"");
    if(!userColors.has(h)) userColors.set(h,"gray");
  }
}

/* ============================================================
   LISTA + RULETA
============================================================ */

function buildParticipants(){
  participants=[...userColors.keys()].map(n=>n.replace("@",""));
}

function updateUI(){
  document.getElementById("totalDetectados").textContent=userColors.size;
  document.getElementById("totalGrises").textContent=participants.length;
  updateList();
  buildWheel();
  document.getElementById("btnBest1").disabled=participants.length===0;
  document.getElementById("btnBest3").disabled=participants.length<3;
}

function updateList(){
  const ul=document.getElementById("listaUsuarios");
  ul.innerHTML="";
  for(const [name] of userColors.entries()){
    const li=document.createElement("li");
    li.className="user-gray";
    li.textContent=name.replace("@","");
    ul.appendChild(li);
  }
}

/* === RULETA === */

let spinWheel=null;
let bestMode="idle";
let best3=0;

function buildWheel(){
  const canvas=document.getElementById("wheel");
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!participants.length){ spinWheel=null; return; }

  const sectors=participants.map(n=>({
    label:n,
    color:`hsl(${Math.random()*360},80%,60%)`,
    textColor:"#fff"
  }));

  spinWheel=new SpinWheel({
    canvasSelector:"#wheel",
    buttonSelector:"#spin",
    sectors
  });

  spinWheel.events.on("finishSpinning",s=>handleWinner(s.label));
}

function handleWinner(name){
  if(bestMode==="idle"){
    showWinner(name);
    return;
  }

  if(bestMode==="best1"){
    showWinner(name);
    bestMode="idle";
    return;
  }

  if(bestMode==="best3"){
    best3++;
    if(best3<=2){
      participants=participants.filter(n=>n!==name);
      alert(`Eliminado: ${name}`);
      updateUI();
      setTimeout(()=>spinWheel.button.click(),400);
    }
    else{
      showWinner(name);
      bestMode="idle";
    }
  }
}

function showWinner(name){
  const box=document.getElementById("winnerBox");
  box.innerHTML=`ðŸŽ‰ GANADOR: <b>${name}</b>`;
  box.style.display="block";
}

/* === BOTONES === */

document.getElementById("btnBest1").onclick=()=>{
  bestMode="best1"; best3=0;
  document.getElementById("winnerBox").style.display="none";
  spinWheel.button.click();
};

document.getElementById("btnBest3").onclick=()=>{
  if(participants.length<3) return alert("MÃ­nimo 3 participantes.");
  bestMode="best3"; best3=0;
  document.getElementById("winnerBox").style.display="none";
  spinWheel.button.click();
};
</script>

</body>
</html>


